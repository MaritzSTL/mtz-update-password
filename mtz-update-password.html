<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="mtz-update-password-behavior.html">

<!--
`mtz-update-password`
Takes a password in from the user and validates it against a set of requirements.

### Styling
Custom property | Description | Default
----------------|-------------|----------
`--mtz-update-password` | A mixin for styling this element | {}
`--mtz-update-password-status-label` | A mixin for styling the valid-status text | {}
`--mtz-update-password-status-label-color` | Allows changing the valid-status text color | --secondary-text-color
`--mtz-update-password-status-icon` | A mixin for styling the valid-status icon | {}
`--mtz-update-password-status-icon-size` | Allows changing the valid-status icon height and width | 15px
`--mtz-update-password-status-icon-color` | Allows changing the valid-status icon color | --secondary-text-color
`--mtz-update-password-valid-status-icon` | A mixin for styling the valid-status icon when valid | {}
`--mtz-update-password-valid-status-icon-color` | Allows changing the valid-status icon color when valid | green
`--mtz-update-password-invalid-status-icon` | A mixin for styling the valid-status icon when invalid | {}

@demo demo/index.html
-->

<dom-module id="mtz-update-password">
  <template>
    <style>
      :host {
        display: block;
        @apply --mtz-update-password;
      }
      .valid-status span {
        font-size: 0.688rem;
        color: var(--mtz-update-password-status-label-color, var(--secondary-text-color));
        @apply --mtz-update-password-status-label;
      }
      .valid-status iron-icon {
        height: var(--mtz-update-password-status-icon-size, 15px);
        width: var(--mtz-update-password-status-icon-size, 15px);
        color: var(--mtz-update-password-status-icon-color, var(--secondary-text-color));
        @apply --mtz-update-password-status-icon;
      }
      .valid-status > :not([invalid]) > iron-icon {
        color: var(--mtz-update-password-valid-status-icon-color, green);
        @apply --mtz-update-password-valid-status-icon;
      }
      .valid-status > [invalid] > iron-icon {
        @apply --mtz-update-password-invalid-status-icon;
      }
    </style>

    <slot name="title"></slot>
    <div class="password-input">
      <paper-input
        id="password"
        type="password"
        value="{{value}}"
        allowed-pattern="[[_buildAllowedPattern(allowedCharacters, allowedSymbols)]]"
        required
        label="[[passwordLabel]]"
        no-label-float="[[noLabelFloat]]"
        placeholder="[[placeholder]]"
        always-float-label="[[alwaysFloatLabel]]"
        autofocus="[[autofocus]]"
        maxlength="[[maxlength]]"
      ></paper-input>
      <template
        is="dom-if"
        if="[[!disableRetype]]">
        <paper-input
          id="retype-password"
          type="password"
          value="{{retypeValue}}"
          allowed-pattern="[[_buildAllowedPattern(allowedCharacters, allowedSymbols)]]"
          label="[[retypePasswordLabel]]"
          no-label-float="[[retypeNoLabelFloat]]"
          placeholder="[[retypePlaceholder]]"
          always-float-label="[[retypeAlwaysFloatLabel]]"
          autofocus="[[retypeAutofocus]]"
          pattern="[[_asPattern(value, allowedSymbols)]]"
          required$="[[_asBoolean(value)]]"
          maxlength="[[maxlength]]"
        ></paper-input>
      </template>
    </div>

    <slot></slot>

    <div class="valid-status">
      <template is="dom-if" if="[[!disableValidStatus]]">
        <template
          is="dom-if"
          if="[[minlength]]">
          <div invalid$="[[validationErrors.minlength]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.minlength, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>A minimum of [[minlength]] characters</span>
          </div>
        </template>
        <template
          is="dom-if"
          if="[[maxlength]]">
          <div invalid$="[[validationErrors.maxlength]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.maxlength, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>A maximum of [[maxlength]] characters</span>
          </div>
        </template>
        <template
          is="dom-if"
          if="[[minUpper]]">
          <div invalid$="[[validationErrors.minUpper]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.minUpper, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>At least [[minUpper]] uppercase</span>
          </div>
        </template>
        <template
          is="dom-if"
          if="[[minNumbers]]">
          <div invalid$="[[validationErrors.minNumbers]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.minNumbers, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>At least [[minNumbers]] number[s]</span>
          </div>
        </template>
        <template
          is="dom-if"
          if="[[minSymbols]]">
          <div invalid$="[[validationErrors.minSymbols]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.minSymbols, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>At least [[minSymbols]] symbol[s]</span>
          </div>
        </template>
        <template
          is="dom-if"
          if="[[minLetters]]">
          <div invalid$="[[validationErrors.minLetters]]">
            <iron-icon
              icon="[[_getStatusIcon(validationErrors.minLetters, validStatusIcon, invalidStatusIcon)]]"
            ></iron-icon>
            <span>At least [[minLetters]] letter[s]</span>
          </div>
        </template>
      </template>
    </div>

    <slot name="footer"></slot>
  </template>

  <script>
    Polymer({
      is: 'mtz-update-password',
      behaviors: [mtz.UpdatePasswordBehavior],
      properties: {
        /* AlwaysFloatLabel override for the password input */
        alwaysFloatLabel: {
          type: Boolean,
          value: false
        },
        /* AutoFocus override for the password input */
        autofocus: {
          type: Boolean,
          value: false
        },
        /* Removes the status section showing if you've hit all the requirements or not */
        disableValidStatus: {
          type: Boolean,
          value: false
        },
        /* NoLabelFloat override for the password input */
        noLabelFloat: String,
        /* The icon to use when a status message is invalid */
        invalidStatusIcon: {
          type: String,
          value: 'icons:highlight-off'
        },
        /* Label override for the password input */
        passwordLabel: {
          type: String,
          value: 'New Password'
        },
        /* Placeholder override for the password input */
        placeholder: String,
        /* AlwaysFloatLabel override for the retype password input */
        retypeAlwaysFloatLabel: {
          type: Boolean,
          value: false
        },
        /* AutoFocus override for the retype password input */
        retypeAutofocus: {
          type: Boolean,
          value: false
        },
        /* NoLabelFloat override for the retype password input */
        retypeNoLabelFloat: String,
        /* Label override for the retype password input */
        retypePasswordLabel: {
          type: String,
          value: 'Confirm New Password'
        },
        /* Placeholder override for the retype password input */
        retypePlaceholder: String,
        /* The icon to use when a status message is valid */
        validStatusIcon: {
          type: String,
          value: 'icons:check-circle'
        }
      },
      /**
       * Takes a value and casts it as a Boolean.
       *
       * @private
       * @param {Object} value
       * @returns {Boolean}
       */
      _asBoolean(value) {
        return Boolean(value);
      },
      /**
       * Takes a value and converts it to a safe pattern to use with paper-input.
       *
       * @private
       * @param {String} value
       * @param {String} symbols
       * @returns {String}
       */
      _asPattern(value, symbols) {
        // Take our value and check to see what symbols require a '\' prefix, then inject it as needed.
        return (value || '').replace(new RegExp(`([${symbols}])`, 'g'), (str, symbol) =>
          (symbols.match(`\\\\\\${symbol}`) || []).length > 0 ? `\\${symbol}` : symbol);
      },
      /**
       * Used to compute the allowedPattern that gets passed to the paper-inputs.
       *
       * @private
       * @param {String} characters
       * @param {String} symbols
       * @param {String}
       */
      _buildAllowedPattern(characters, symbols) {
        return `[${characters}${symbols}]`;
      },
      /**
       * Returns the validStatusIcon when isValid otherwise the invalidStatusIcon.
       *
       * @private
       * @param {Boolean} invalid
       * @param {String} validStatusIcon
       * @param {String} invalidStatusIcon
       * @returns {String}
       */
      _getStatusIcon(invalid, validStatusIcon, invalidStatusIcon) {
        return invalid ? invalidStatusIcon : validStatusIcon;
      }
    });
  </script>
</dom-module>
