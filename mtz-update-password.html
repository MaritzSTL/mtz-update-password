<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="mtz-update-password-behavior.html">
<link rel="import" href="mtz-validation-status.html">

<!--
`mtz-update-password`
Takes a password in from the user and validates it against a set of requirements.

### Styling
Custom property | Description | Default
----------------|-------------|----------
`--mtz-update-password` | A mixin for styling this element | {}
`--mtz-update-password-valid-status` | A mixin for styling the valid-status group | {}

@demo demo/index.html
-->

<dom-module id="mtz-update-password">
  <template>
    <style>
      :host {
        display: block;
        @apply --mtz-update-password;
      }
      .valid-status {
        @apply --mtz-update-password-valid-status;
      }
    </style>

    <slot name="title"></slot>
    <div class="password-input">
      <paper-input
        id="password"
        type="password"
        value="{{value}}"
        allowed-pattern="[[_buildAllowedPattern(allowedCharacters, allowedSymbols)]]"
        required
        label="[[passwordLabel]]"
        no-label-float="[[noLabelFloat]]"
        placeholder="[[placeholder]]"
        always-float-label="[[alwaysFloatLabel]]"
        autofocus="[[autofocus]]"
        maxlength="[[maxlength]]"
      ></paper-input>
      <template
        is="dom-if"
        if="[[!disableRetype]]">
        <paper-input
          id="retype-password"
          type="password"
          value="{{retypeValue}}"
          allowed-pattern="[[_buildAllowedPattern(allowedCharacters, allowedSymbols)]]"
          label="[[retypePasswordLabel]]"
          no-label-float="[[retypeNoLabelFloat]]"
          placeholder="[[retypePlaceholder]]"
          always-float-label="[[retypeAlwaysFloatLabel]]"
          autofocus="[[retypeAutofocus]]"
          pattern="[[_asPattern(value, allowedSymbols)]]"
          required$="[[_asBoolean(value)]]"
          maxlength="[[maxlength]]"
        ></paper-input>
      </template>
    </div>

    <slot></slot>

    <mtz-validation-status
      errors="[[validationErrors]]"
      invalidIcon="[[invalidStatusIcon]]"
      validIcon="[[validStatusIcon]]"
      messages="[[validationMessages]]"
      values="[[_validationValues]]"
    ></mtz-validation-status>

    <slot name="footer"></slot>
  </template>

  <script>
    Polymer({
      is: 'mtz-update-password',
      behaviors: [mtz.UpdatePasswordBehavior],
      properties: {
        /* AlwaysFloatLabel override for the password input */
        alwaysFloatLabel: {
          type: Boolean,
          value: false
        },
        /* AutoFocus override for the password input */
        autofocus: {
          type: Boolean,
          value: false
        },
        /* Removes the status section showing if you've hit all the requirements or not */
        disableValidStatus: {
          type: Boolean,
          value: false
        },
        /* NoLabelFloat override for the password input */
        noLabelFloat: String,
        /* The icon to use when a status message is invalid */
        invalidStatusIcon: String,
        /* Label override for the password input */
        passwordLabel: {
          type: String,
          value: 'New Password'
        },
        /* Placeholder override for the password input */
        placeholder: String,
        /* AlwaysFloatLabel override for the retype password input */
        retypeAlwaysFloatLabel: {
          type: Boolean,
          value: false
        },
        /* AutoFocus override for the retype password input */
        retypeAutofocus: {
          type: Boolean,
          value: false
        },
        /* NoLabelFloat override for the retype password input */
        retypeNoLabelFloat: String,
        /* Label override for the retype password input */
        retypePasswordLabel: {
          type: String,
          value: 'Confirm New Password'
        },
        /* Placeholder override for the retype password input */
        retypePlaceholder: String,
        /* The icon to use when a status message is valid */
        validStatusIcon: String
      },
      /**
       * Takes a value and casts it as a Boolean.
       *
       * @private
       * @param {Object} value
       * @returns {Boolean}
       */
      _asBoolean(value) {
        return Boolean(value);
      },
      /**
       * Takes a value and converts it to a safe pattern to use with paper-input.
       *
       * @private
       * @param {String} value
       * @param {String} symbols
       * @returns {String}
       */
      _asPattern(value, symbols) {
        // Take our value and check to see what symbols require a '\' prefix, then inject it as needed.
        return (value || '').replace(new RegExp(`([${symbols}])`, 'g'), (str, symbol) =>
          (symbols.match(`\\\\\\${symbol}`) || []).length > 0 ? `\\${symbol}` : symbol);
      },
      /**
       * Used to compute the allowedPattern that gets passed to the paper-inputs.
       *
       * @private
       * @param {String} characters
       * @param {String} symbols
       * @param {String}
       */
      _buildAllowedPattern(characters, symbols) {
        return `[${characters}${symbols}]`;
      }
    });
  </script>
</dom-module>
